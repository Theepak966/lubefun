<div class="flex flex-col items-center gap-4">

	<div class="crypto-panel flex flex-col gap-4 w-full max-w-4xl">
		<!-- Step 1: Select Currency -->
		<div class="flex flex-col gap-2">
			<label class="text-sm font-semibold text-muted-foreground">1. Select Currency</label>
			<div class="bg-card border-2 border-secondary rounded-lg p-4">
				<div class="flex flex-row items-center gap-3">
					<img src="/img/payments/crypto/<%= app.paths[2] %>.png" alt="<%= response.deposit.name %>" style="width: 16px; height: 16px; max-width: 16px; max-height: 16px;">
					<div class="flex flex-col">
						<div class="font-bold text-lg"><%= response.deposit.name %></div>
						<div class="text-xs text-muted-foreground"><%= app.paths[2].toUpperCase() %></div>
					</div>
				</div>
			</div>
		</div>

		<!-- Step 2: Select Network -->
		<div class="flex flex-col gap-2">
			<label class="text-sm font-semibold text-muted-foreground">2. Select Network</label>
			<div class="bg-card border-2 border-secondary rounded-lg p-4">
				<div class="font-bold text-lg"><%= response.deposit.network %></div>
			</div>
		</div>

		<!-- Step 3: Deposit Address -->
		<div class="flex flex-col gap-2">
			<label class="text-sm font-semibold text-muted-foreground">3. Deposit Address</label>
			<div class="bg-card border-2 border-secondary rounded-lg p-4" id="crypto_deposit_panel">
				<div class="flex flex-row gap-4 responsive">
					<!-- QR Code -->
					<div class="crypto-deposit-qrcode <%= app.paths[2] %> flex-shrink-0" id="crypto_deposit_qrcode" style="width: 200px; height: 200px; min-width: 200px;"></div>

					<!-- Address Field -->
					<div class="flex flex-col gap-3 flex-1">
						<div class="text-xs text-muted-foreground">
							Deposit value: <span id="crypto_deposit_payment_value">-</span> <%= app.paths[2].toUpperCase() %>
							&nbsp;|&nbsp;
							Credits: <span id="crypto_deposit_payment_amount">-</span>
						</div>

						<div class="flex flex-row items-center gap-2">
							<%- include('./components/inputField.ejs', {
								type: 'text',
								placeholder: 'Deposit address',
								id: 'crypto_deposit_payment_address',
								value: '',
								attributes: [
									{ name: 'readonly', value: 'readonly' }
								]
							}); %>
							<button type="button" class="button button-primary shadow-2 px-4 py-2" data-copy="input" data-input="#crypto_deposit_payment_address">
								<i class="fa fa-copy" aria-hidden="true"></i>
							</button>
						</div>

						<!-- Important Instructions -->
						<div class="bg-danger-10 border-2 border-danger rounded-lg p-3">
							<div class="text-sm font-semibold text-danger">
								Send only <%= app.paths[2].toUpperCase() %> on the <%= response.deposit.network %> network. $<%= response.deposit.amounts.min %> minimum deposit, 1 confirmation required.
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- Loading State -->
		<div class="flex flex-col gap-2" id="crypto_deposit_loading" style="display: none;">
			<div class="bg-card border-2 border-secondary rounded-lg p-4">
				<div class="flex flex-row items-center justify-center gap-3">
					<div class="spinner"></div>
					<div class="text-sm text-muted-foreground">Generating deposit address...</div>
				</div>
			</div>
		</div>

		<!-- Loading State -->
		<div class="flex flex-col gap-2" id="crypto_deposit_loading" style="display: none;">
			<div class="bg-card border-2 border-secondary rounded-lg p-4">
				<div class="flex flex-row items-center justify-center gap-3">
					<div class="spinner"></div>
					<div class="text-sm text-muted-foreground">Generating deposit address...</div>
				</div>
			</div>
		</div>

		<!-- Back Button -->
		<div class="flex justify-start">
			<a href="/deposit"><button class="button button-accent shadow-2 flex flex-row gap-2 items-center justify-center">
				<i class="fa fa-arrow-left" aria-hidden="true"></i>
				<span>Back to Options</span>
			</button></a>
		</div>
	</div>
</div>

<script>
/**
 * Auto-generate deposit address on page load.
 * NOWPayments will automatically detect any amount sent to this address.
 */
(function() {
	var currency = '<%= app.paths[2] %>';
	var loadingEl = document.getElementById('crypto_deposit_loading');
	var hasRequested = false;
	var maxWaitMs = 20000;
	var startMs = Date.now();

	function autoGenerateDeposit() {
		if(hasRequested) return;

		// We must wait for the global socket bootstrap to complete.
		// The server will reject early requests with "Your page is now inactive" until the
		// `site/connected` message is processed and `INITIALIZED` is set to true.
		if(typeof SOCKET === 'undefined' || !SOCKET || !SOCKET.connected || typeof INITIALIZED === 'undefined' || !INITIALIZED) {
			if(Date.now() - startMs > maxWaitMs) {
				if(loadingEl) loadingEl.style.display = 'none';
				if(typeof notify === 'function') notify('error', 'Could not connect to server. Please refresh and try again.');
				return;
			}
			setTimeout(autoGenerateDeposit, 250);
			return;
		}

		// Check if send_request_socket function exists
		if(typeof send_request_socket === 'function') {
			hasRequested = true;
			if(loadingEl) loadingEl.style.display = 'block';
			
			// Send deposit request without value (will use minimum)
			send_request_socket({
				type: 'crypto',
				command: 'deposit',
				currency: currency
				// No value - will auto-generate with minimum
			});
		} else if(SOCKET && SOCKET.connected) {
			hasRequested = true;
			if(loadingEl) loadingEl.style.display = 'block';
			
			// Fallback: emit directly
			SOCKET.emit('request', {
				type: 'crypto',
				command: 'deposit',
				currency: currency
			});
		} else {
			// Socket not ready, try again
			setTimeout(autoGenerateDeposit, 200);
		}
	}

	// Wait for socket connection
	function waitForSocket() {
		if(typeof SOCKET !== 'undefined' && SOCKET) {
			if(SOCKET.connected) {
				// Socket already connected, generate immediately
				setTimeout(autoGenerateDeposit, 500);
			} else {
				// Wait for connection
				SOCKET.on('connect', function() {
					setTimeout(autoGenerateDeposit, 500);
				});
			}
		} else {
			// Socket not defined yet, wait a bit
			setTimeout(waitForSocket, 200);
		}
	}

	// Start when DOM is ready
	if(document.readyState === 'loading') {
		document.addEventListener('DOMContentLoaded', function() {
			setTimeout(waitForSocket, 1000);
		});
	} else {
		// DOM already loaded
		setTimeout(waitForSocket, 1000);
	}

	// Listen for crypto_payment response to hide loading
	if(typeof SOCKET !== 'undefined' && SOCKET) {
		SOCKET.on('message', function(msg) {
			if(msg && msg.type === 'offers' && msg.method === 'crypto_payment') {
				if(loadingEl) loadingEl.style.display = 'none';
				hasRequested = true;
			}

			// If the server rejects the request, stop the spinner and surface the error.
			if(msg && msg.type === 'message' && msg.method === 'error') {
				if(loadingEl) loadingEl.style.display = 'none';
			}
		});
	} else {
		// Set up listener when socket becomes available
		var socketCheck = setInterval(function() {
			if(typeof SOCKET !== 'undefined' && SOCKET) {
				clearInterval(socketCheck);
				SOCKET.on('message', function(msg) {
					if(msg && msg.type === 'offers' && msg.method === 'crypto_payment') {
						if(loadingEl) loadingEl.style.display = 'none';
						hasRequested = true;
					}
					if(msg && msg.type === 'message' && msg.method === 'error') {
						if(loadingEl) loadingEl.style.display = 'none';
					}
				});
			}
		}, 100);
		
		// Clear interval after 10 seconds
		setTimeout(function() {
			clearInterval(socketCheck);
		}, 10000);
	}
})();
</script>
